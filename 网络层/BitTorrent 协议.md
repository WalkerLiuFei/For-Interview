# BitTorrent 协议

## BitTorrent 协议组成

一个BitTorrent文件传输过程，通常需要由以下几个部分组成：

-  WEB服务器 ： 用于传输种子文件 
-  文件元信息(metainfo，种子) ： 文件中的信息
-  BitTorrent Tracker ： 用于注册P2P协议中的参与者
-  原始下载者（发布资源者） ： 
-  终端用户浏览器(下载.torrent种子)
-  终端用户下载者

## DHT

distributed hash table

DHT = Distributed Hash Table 中文分布式哈希表。
一句话说明DHT的作用：代替Tracker服务器，通过分布式存储的方式将原本存储在Tracker中的信息存储到各个用户中。

有了DHT以后，下载种子文件的过程变成了：首先，从DHT中查询种子对应的活跃用户。然后，根据获得的用户信息开始p2p下载。和原始BT协议不同的地方只是在于改变了获取活跃用户的方式。

因而DHT可以说是一个分布式数据库。网络中的所有用户构成的DHT网络是一个大的数据库。每个用户都存储一小部分数据。



## BitTorrent 通信流程和网络包结构

BitTorrent协议支持基于TCP或UTP网络协议进行数据传输，但是由于**TCP协议是有连接的，需要先进行握手。在进行数据传输的过程中，每个种子会占有大量的TCP连接，从而占有大量的用户带宽**。这给其他需要高实时性的应用造成很大的网络压力。

于是BitTorrent又支持`UTP协议`用来进行数据传输，这也是当前大部分BT下载客户端所采用的实现方式。UTP(uTorrent Transport Protocol)是基于UDP网络协议的，也就是无连接协议，采用这种协议进行数据交换，可以很容易进行带宽控制，不会造成网络拥堵。



![img](https://img-blog.csdn.net/20130625233010343?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvd2VuZ3Bpbmdibw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)



Fig. 1 UTP包结构(来自bittorrent.org)

1. type：数据包类型，0--带负载数据包，就是通常在连接建立后，上传数据或下载数据的包；1--连接结束数据包，结束一个连接；2--数据回应包，当一个peer收到一个带负载数据包后，会回一个ACK包，来表示这个包已正确接收，有点类似于TCP的SYN的感觉，但是这个是在UDP包的数据段做连接控制；3--重置连接；4--开始一个连接
2. ver：协议版本，通常为1
3. extension：扩展段，用于支持BEPs
4. connection_id：连接id，同一个连接id的数据包属于一个连接，一般每两个peer之间会开两个连接，一个用于发，一个用于收
5. timestamp_microseconds：包的发送时间
6. timestamp_difference_microseconds：对于当前连接，最近收到的包时间和当前要发送的包之间的时间间
7. wnd_size：发送方当前剩余窗口大小，用于进行速度和带宽控制。BitTorrent协议中每一个发出去的数据包，都要求接收方回一个ACK包。而一个peer的窗口大小是指当前发送出去，但还没有收到回应的包的总大小，单位为字节。每一个peer都一个最大窗口值和一个窗口大小上限值。当wnd_size小于最小UTP包大小的时候，发送方会停止发送数据包，或调整每个数据包的数据负载大小
8. seq_nr：相对于一个连接，数据包的序列号，以一个包为计数单位
9. ack_nr：发送方最近接收到的包的序列号
   

0000   78 ac c0 55 45 4a 00 0c 86 23 b8 00 08 00 45 00

0010   00 30 2f e7 00 00 66 11 a4 23 01 a4 60 2e db f6

0020   42 ea 8f b9 cf 46 00 1c 00 00 21 00 19 a2 ec 07

0030   ea 27 c3 62 4a be 00 37 f5 10 11 89 32 d4

其中0x00-0x29是UDP header，这里不再分析。咱来看一下它的数据部分：


 0x2是type字段，代表这是一个数据回应包

0x1是它的协议版本号
 0x00是它的扩展字段
 00代表该包没有扩展信息
 0x19a2是该包的连接id，这是一个随机数
 0xec07ea27是该包的发送时间
 0xc3624abe是这个包的发送方最近一次接收包到这次发生包之间的间隔，间隔这么长，表示当前网络环境不行，数据传输速度不是很快
 0x0037f510是发送方的窗口大小，也就是说当前发送方还可以接收3.5MB的数据
 0x1189是该数据包的序列包，也就意味着发送方在这个连接上已经发送了4489个包
 0x32d4是该发送方最近接受到的包序列号
