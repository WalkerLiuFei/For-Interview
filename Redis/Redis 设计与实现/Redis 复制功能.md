# Redis的复制功能

旧的`SYNC`方式同步的步骤和弊端

1. 主服务器执行`BGSAVE`命令生成`RDB`文件，这个步骤会耗费主CPU大量CPU，内存和磁盘IO资源
2. 主服务器将自己生成的`RDB`文件发送给从服务器，消耗带宽和流量。
3. 接收到RDB文件的从服务器需要载入主服务器发来的`RDB`文件，并且在载入期间，从服务器会因为阻塞而无法处理命令请求。

新的`PSYNC`命令

1. 完整的重同步命令 ,用于处理初次复制情况，完整重同步的执行步骤和`SYNC`命令的执行步骤是一样的，都是通过由主服务器创建发送RDB文件，以及向从服务器发送保存在缓冲区里面的命令来进行同步的。
2. 部分重同步则用于处理断线后重复制情况 ： 当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接受并执行这些写命令，就可以将数据库更新至主服务器当前所处的状态。

Redis通过`PSYNC`方法代替`SYNC`方法

`PSYNC`的短线后重复制通过三个部分组成

1. 复制偏移量
2. 主服务器的复制积压缓冲区 ：
3. 服务器的运行ID，每个服务器都有自己的一套运行ID



通过从服务器的发送`SLAVEOF` 命令，可以让一个从服务器去复制一个主服务：

`SLAVEOF  <master_ip> <master_port>` 

心跳检查 ：

在命令复制过程中，从服务器默认会以每秒一次的频率，向主服务器发送心跳命令

`REPLCAONF ACK <replication_offset>`

1. 检测主从服务器的网络连接状态
2. 辅助实现`min-slave`选项
3. 检测命令丢失



