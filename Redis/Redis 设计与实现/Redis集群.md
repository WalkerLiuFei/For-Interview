# Redis集群

Redis集群是Redis提供的分布式数据库方案，集群通过分片(sharding)来进行数据共享，并提供复制和故障转移功能。

## 建立节点

首先， 集群中所有节点在启动时，需要在集群模式下启动。通过`CLUSTER MEET <IP> <PORT>` 来添加对象的节点进入集群。

集群里面的每个node都保存了集群中其他节点的信息。这个信息是在执行`CLUSTER MEET <ip> <port>`时产生的，目的是为将来的进一步通信打好基础。

节点之间的通信是通过**Gossip** 协议完成的

## 槽指派

一个集群可以处理 16384个槽，每个节点可以处理这16384个槽中一个或者至多16384个槽。数据库中每个键都是这个16384个槽中的一个。

只有当 16384个槽都已经分配以后，这个集群才算是已经上线的状态。

## 重新分片

Redis集群重新分片可以不需要将集群下线，并且相关槽所属的键值对也会从源节点被移动到目标节点。通过`Redis-trib` 命令对集群的单个槽进行重新分片。

redis-trib 重新分片过程 ： 

1. 对目标节点发送`CLUSTER SETSLOT <slot> IMPORTING <SOURCE_ID> 命令`
2. 对源节点发送`CLUSTER SETSLOT <slot> MIGRATING <target id>` 命令
3. 

## ASK错误

ASK错误其实就是在做 slot 迁移过程中，如果有客户端执行正在迁移的键的操作时，指示客户端去目标节点寻找。



集群中的节点通过发送和接收消息来进行通信，常见的消息包括`MEET`,`PING`,`PONG`,`PUBLISH`,`FAIL` 五种