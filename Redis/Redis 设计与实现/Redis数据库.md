# Redis数据库

## 服务器中的数据库

Redis默认会创建16个数据库，在默认情况下Redis客户端使用的是0号数据库，可以通过`SELECT`命令进行数据库选择。**由于Redis没有查询当前Redis-cli 所在的会话是第几号数据库，所以在执行命令前需要通过`SELECT`命令首先进行数据库选择**



## 数据库的键空间

+ 键空间的键也就是数据库的键，每个键是一个字符串对象。

+ 键空间的值也就是数据库的值，每个值可以是字符串对象，列表对象，Hash表对象，集合对象和有序集合对象。

### 添加新键

通过例如`SET` 这样的命令，可以增增加一个劲键值。

### 删除键

`DEL KEY`,通过这个命令删除一个键值。

### 更新键

对一个数据库键进行更新，实际上就是对键空间里面键所对应的值对象进行更新

### 读写键空间时的维护操作

当使用Redis命令对数据库进行读写时，服务器不仅会对键空间执行指定的读写操作，还会执行一些额外的维护操作

1. R/W取一个键之后,更新键空间的命中次数
2. 更新键的`LRU` （最后一次使用）时间，这个值用于计算键的闲置时间
3. 如果服务器在读取一个键时发现键过期，服务器会优先删除这个键（过期键）
4. 如果有客户端使用`watch`命令监视了某个键，那么服务器在被监视的键进行修改了之后，会将这个键标记为脏。从而让 watch的客户端注意到这个键
5. 服务器每次修改一个键之后，都会对脏键计数器的值增1，这个计数器会触发服务器的持久化以及复制操作。
6. 如果服务器开启了数据库通知功能，那么在对键进行修改之后，服务器将按配置发送相应的数据库通知

## 设置键的生存时间或过期时间

通过`EXPIRE` 或者`PEXPIRE` ，`EXPIREAT`,`PEXPIREAT`命令，客户端可移以秒或者毫秒精度,或以准确的时间设置键的过期时间

### 过期时间的底层实现

通过一个时间戳标记一个键的过期时间，当服务器达到这个时间戳时，会主动回收这个键。因为Redis是单线程应用，定时查询删除键值浪费CPU，所以Redis实际上是通过惰性和定期删除结合的方式进行键删除的。

惰性删除就是键过期了，还依然存着，当主动获取键时再检查键的过期时间并确定是否删除。

定期删除通过一定的定期时间进行键值的过期检查和删除。

通过结合惰性删除和定期删除，可以较好的在CPU和内存占用间寻找平衡。

定期时间是可以通过配置文件配置的。

### 删除一个键的过期时间

`PERSIST` 命令消除一个键的过期时间

###  计算并返回一个键的过期时间

`TTL`或者`PTTL` 



## AOF,RDB和复制功能对过期键的处理

### 生成RDB文件

在执行`SAVE`命令或者`BGSAVE`命令创建一个新的RDB文件时，程序会对数据库中的键进行检查，已过期的键不会被保存到新创建的RDB文件中。

### 载入RDB文件

当Redis启动 载入RDB文件时，

1. 主服务器角色启动会对RDB文件中的过期键进行检查
2. 从服务器角色不会检查过期键，但是因为从服务器载入到内存的键还要同步给主服务器，在同步过程中，主服务器会对过期键进行检查。

### AOF

当服务器在以AOF持久化模式运行中，遇到过期键就在AOF文件中追加一条`DEL`命令

### 复制模式

当Redis在复制模式下工作时，从服务器中键的过期时间由主服务器主动通知。这样可以保证主动服务器的数据一致性。从服务器不会主动检查删除键

**主从模式中的坑**



但是由于Redis键的过期删除策略是定期或者惰性的，这就导致键过期时主服务器通知从服务器肯定会有一定的延迟，这就导致client在从从服务器读键值时会有可能读到的是过期的键。

### 

